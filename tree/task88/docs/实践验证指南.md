# Go-Ethereum 实践验证指南

## 一、环境准备

### 1.1 系统要求

- **操作系统**：Linux/macOS/Windows
- **Go版本**：>= 1.19
- **硬件要求**：
  - CPU: 2核以上
  - 内存: 4GB+（开发模式）/ 16GB+（主网）
  - 磁盘: 10GB+（开发模式）/ 1TB+（主网全节点）

### 1.2 安装Go环境

**Windows:**
```powershell
# 下载并安装Go
# https://golang.org/dl/

# 验证安装
go version
```

**Linux/macOS:**
```bash
# 下载Go
wget https://golang.org/dl/go1.21.0.linux-amd64.tar.gz

# 解压
sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz

# 设置环境变量
export PATH=$PATH:/usr/local/go/bin
export GOPATH=$HOME/go

# 验证
go version
```

---

## 二、编译Geth

### 2.1 克隆源码

```bash
# 克隆官方仓库
git clone https://github.com/ethereum/go-ethereum.git
cd go-ethereum

# 切换到稳定版本（可选）
git checkout v1.13.0
```

### 2.2 编译Geth

**方法一：使用Make（推荐）**
```bash
# 编译所有工具
make all

# 仅编译geth
make geth

# 编译输出路径
# ./build/bin/geth
```

**方法二：使用Go Build**
```bash
# 进入cmd/geth目录
cd cmd/geth

# 编译
go build -o geth

# 验证
./geth version
```

**Windows编译注意事项：**
```powershell
# 安装MinGW（用于CGo）
# 下载: https://sourceforge.net/projects/mingw-w64/

# 设置环境变量
$env:CGO_ENABLED=1
$env:CC="gcc"

# 编译
go build -o geth.exe ./cmd/geth
```

### 2.3 验证编译结果

```bash
# 查看版本
./build/bin/geth version

# 输出示例：
# Geth
# Version: 1.13.0-stable
# Architecture: amd64
# Go Version: go1.21.0
# Operating System: linux
```

---

## 三、启动私有开发链

### 3.1 使用开发模式（--dev）

**最简单的启动方式：**
```bash
# 启动开发链
./build/bin/geth --dev --http --http.api eth,web3,personal,net

# 参数说明：
# --dev: 开发模式，自动挖矿，预分配账户
# --http: 启用HTTP-RPC服务器
# --http.api: 开放的API模块
```

**带数据目录启动：**
```bash
# 创建数据目录
mkdir -p ./devchain

# 启动并指定数据目录
./build/bin/geth \
  --dev \
  --datadir ./devchain \
  --http \
  --http.addr "127.0.0.1" \
  --http.port 8545 \
  --http.api "eth,web3,personal,net,debug" \
  --http.corsdomain "*" \
  --ws \
  --ws.addr "127.0.0.1" \
  --ws.port 8546 \
  --ws.api "eth,web3,personal,net" \
  console
```

**参数详解：**
```
--datadir ./devchain       # 数据存储目录
--http.addr 127.0.0.1     # HTTP-RPC监听地址
--http.port 8545          # HTTP-RPC端口
--http.api                # 开放的API（用逗号分隔）
--http.corsdomain "*"     # CORS设置（开发用）
--ws                      # 启用WebSocket
--ws.port 8546           # WebSocket端口
console                   # 启动交互式控制台
```

### 3.2 使用自定义创世区块

**创建创世文件（genesis.json）：**
```json
{
  "config": {
    "chainId": 12345,
    "homesteadBlock": 0,
    "eip150Block": 0,
    "eip155Block": 0,
    "eip158Block": 0,
    "byzantiumBlock": 0,
    "constantinopleBlock": 0,
    "petersburgBlock": 0,
    "istanbulBlock": 0,
    "berlinBlock": 0,
    "londonBlock": 0,
    "clique": {
      "period": 5,
      "epoch": 30000
    }
  },
  "difficulty": "1",
  "gasLimit": "8000000",
  "alloc": {
    "0x1234567890123456789012345678901234567890": {
      "balance": "1000000000000000000000"
    }
  }
}
```

**初始化并启动：**
```bash
# 初始化创世区块
./build/bin/geth --datadir ./mychain init genesis.json

# 启动节点
./build/bin/geth \
  --datadir ./mychain \
  --networkid 12345 \
  --http \
  --http.api eth,web3,personal,net \
  console
```

---

## 四、控制台操作验证

### 4.1 连接到Geth控制台

**方法一：启动时带console参数**
```bash
./build/bin/geth --dev console
```

**方法二：使用attach连接运行中的节点**
```bash
# 通过IPC连接
./build/bin/geth attach ./devchain/geth.ipc

# 通过HTTP连接
./build/bin/geth attach http://127.0.0.1:8545
```

### 4.2 基础命令验证

```javascript
// 1. 查看区块高度
> eth.blockNumber
0

// 2. 查看账户列表
> eth.accounts
["0x1234..."]

// 3. 查看账户余额
> eth.getBalance(eth.accounts[0])
1000000000000000000000  // 单位：wei

// 转换为Ether
> web3.fromWei(eth.getBalance(eth.accounts[0]), "ether")
"1000"

// 4. 创建新账户
> personal.newAccount("password123")
"0xabcd..."

// 5. 解锁账户
> personal.unlockAccount(eth.accounts[0], "password123", 300)
true  // 解锁300秒

// 6. 查看节点信息
> admin.nodeInfo
{
  enode: "enode://...",
  id: "...",
  ip: "127.0.0.1",
  name: "Geth/v1.13.0-stable/...",
  ports: {
    discovery: 30303,
    listener: 30303
  },
  protocols: {
    eth: {...}
  }
}

// 7. 查看当前Gas价格
> eth.gasPrice
1000000000  // 1 Gwei

// 8. 查看网络ID
> net.version
"1"  // 主网
```

### 4.3 启动/停止挖矿

```javascript
// 开发模式下通常自动挖矿，以下是手动控制

// 1. 检查是否在挖矿
> eth.mining
false

// 2. 启动挖矿（1个线程）
> miner.start(1)
null

// 等待几秒后查看区块高度
> eth.blockNumber
15  // 已产生15个区块

// 3. 查看挖矿状态
> eth.mining
true

// 4. 查看算力（仅PoW有效）
> eth.hashrate
1234567

// 5. 停止挖矿
> miner.stop()
true

// 6. 设置矿工地址
> miner.setEtherbase(eth.accounts[0])
true
```

---

## 五、交易操作实践

### 5.1 发送Ether交易

```javascript
// 1. 准备账户
var sender = eth.accounts[0]
var receiver = eth.accounts[1]  // 或创建新账户

// 2. 检查余额
> web3.fromWei(eth.getBalance(sender), "ether")
"1000"

> web3.fromWei(eth.getBalance(receiver), "ether")
"0"

// 3. 解锁发送者账户
> personal.unlockAccount(sender, "password", 300)
true

// 4. 发送交易
> eth.sendTransaction({
    from: sender,
    to: receiver,
    value: web3.toWei(10, "ether"),
    gas: 21000,
    gasPrice: web3.toWei(1, "gwei")
})
"0x1234abcd..."  // 交易哈希

// 5. 查询交易状态
> eth.getTransaction("0x1234abcd...")
{
  blockHash: "0x...",
  blockNumber: 123,
  from: "0x...",
  to: "0x...",
  value: 10000000000000000000,
  gas: 21000,
  gasPrice: 1000000000,
  hash: "0x1234abcd...",
  nonce: 0
}

// 6. 查询交易收据
> eth.getTransactionReceipt("0x1234abcd...")
{
  blockHash: "0x...",
  blockNumber: 123,
  contractAddress: null,
  cumulativeGasUsed: 21000,
  from: "0x...",
  gasUsed: 21000,
  logs: [],
  status: "0x1",  // 1=成功, 0=失败
  to: "0x...",
  transactionHash: "0x1234abcd..."
}

// 7. 验证余额变化
> web3.fromWei(eth.getBalance(receiver), "ether")
"10"
```

### 5.2 部署智能合约

**Solidity合约示例（SimpleStorage.sol）：**
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleStorage {
    uint256 private storedData;
    
    event DataStored(uint256 data);
    
    function set(uint256 x) public {
        storedData = x;
        emit DataStored(x);
    }
    
    function get() public view returns (uint256) {
        return storedData;
    }
}
```

**部署流程：**

```javascript
// 1. 编译合约（使用solc编译器）
// solc --bin --abi SimpleStorage.sol

// 2. 准备字节码和ABI
var bytecode = "0x608060405234801561001057600080fd5b50..."
var abi = [{"inputs":[],"name":"get","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},...]

// 3. 创建合约对象
var SimpleStorage = eth.contract(abi)

// 4. 部署合约
var contract = SimpleStorage.new({
    from: eth.accounts[0],
    data: bytecode,
    gas: 1000000
}, function(err, contract) {
    if (err) {
        console.log("Error:", err)
    } else if (contract.address) {
        console.log("Contract deployed at:", contract.address)
    }
})

// 5. 等待挖矿确认
// 查看合约地址
> contract.address
"0x5678..."

// 6. 调用合约方法
// 读取数据（不需要gas）
> contract.get()
0

// 写入数据（需要交易）
> contract.set(42, {from: eth.accounts[0], gas: 100000})
"0xtxhash..."

// 等待确认后再次读取
> contract.get()
42

// 7. 查看事件日志
> eth.getTransactionReceipt("0xtxhash...").logs
[{
  address: "0x5678...",
  topics: ["0x...DataStored事件签名"],
  data: "0x000000000000000000000000000000000000000000000000000000000000002a" // 42的十六进制
}]
```

---

## 六、使用外部工具连接

### 6.1 使用curl调用RPC

```bash
# 获取区块号
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
  http://127.0.0.1:8545

# 输出：
# {"jsonrpc":"2.0","id":1,"result":"0xf"}

# 获取账户余额
curl -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_getBalance","params":["0x1234...","latest"],"id":1}' \
  http://127.0.0.1:8545

# 发送交易
curl -X POST -H "Content-Type: application/json" \
  --data '{
    "jsonrpc":"2.0",
    "method":"eth_sendTransaction",
    "params":[{
      "from":"0x...",
      "to":"0x...",
      "value":"0xde0b6b3a7640000",
      "gas":"0x5208"
    }],
    "id":1
  }' \
  http://127.0.0.1:8545
```

### 6.2 使用Web3.js连接

**安装Web3.js：**
```bash
npm install web3
```

**示例代码（test.js）：**
```javascript
const Web3 = require('web3');

// 连接到本地Geth节点
const web3 = new Web3('http://127.0.0.1:8545');

async function main() {
    // 获取区块号
    const blockNumber = await web3.eth.getBlockNumber();
    console.log('Current block:', blockNumber);
    
    // 获取账户列表
    const accounts = await web3.eth.getAccounts();
    console.log('Accounts:', accounts);
    
    // 获取余额
    const balance = await web3.eth.getBalance(accounts[0]);
    console.log('Balance:', web3.utils.fromWei(balance, 'ether'), 'ETH');
    
    // 发送交易
    const receipt = await web3.eth.sendTransaction({
        from: accounts[0],
        to: accounts[1],
        value: web3.utils.toWei('1', 'ether'),
        gas: 21000
    });
    console.log('Transaction hash:', receipt.transactionHash);
}

main().catch(console.error);
```

**运行：**
```bash
node test.js
```

### 6.3 使用Metamask连接

1. 安装Metamask浏览器插件
2. 添加自定义网络：
   - 网络名称：Local Geth
   - RPC URL：http://127.0.0.1:8545
   - 链ID：12345（根据你的genesis.json）
   - 货币符号：ETH

3. 导入账户：
   - 使用私钥或助记词导入开发账户

---

## 七、调试和监控

### 7.1 启用调试API

```bash
./build/bin/geth \
  --dev \
  --http \
  --http.api "eth,web3,debug,personal,net" \
  console
```

**调试命令：**
```javascript
// 1. 追踪交易执行
> debug.traceTransaction("0xtxhash...")
{
  gas: 21000,
  returnValue: "",
  structLogs: [
    {pc: 0, op: "PUSH1", gas: 21000, ...},
    {pc: 2, op: "PUSH1", gas: 20997, ...},
    ...
  ]
}

// 2. 查看内存池状态
> txpool.status
{
  pending: 5,
  queued: 2
}

// 3. 查看内存池详情
> txpool.content

// 4. 查看当前Gas价格建议
> eth.gasPrice
1000000000
```

### 7.2 性能监控

```javascript
// 查看节点运行时间
> admin.nodeInfo.uptime

// 查看对等节点
> admin.peers
[{
  id: "...",
  name: "Geth/v1.13.0",
  network: {
    localAddress: "127.0.0.1:30303",
    remoteAddress: "192.168.1.100:30303"
  }
}]

// 查看同步状态
> eth.syncing
false  // 已同步
// 或
{
  currentBlock: 1000,
  highestBlock: 5000,
  startingBlock: 0
}  // 同步中
```

---

## 八、常见问题排查

### 8.1 编译错误

**问题：CGO相关错误**
```
cgo: C compiler "gcc" not found
```

**解决：**
```bash
# Linux
sudo apt-get install build-essential

# macOS
xcode-select --install

# Windows
# 安装MinGW-w64
```

### 8.2 启动错误

**问题：端口占用**
```
Fatal: Error starting protocol stack: listen tcp :8545: bind: address already in use
```

**解决：**
```bash
# 查找占用进程
netstat -ano | findstr :8545  # Windows
lsof -i :8545                 # Linux/macOS

# 修改端口
./build/bin/geth --dev --http.port 8546
```

### 8.3 交易失败

**检查清单：**
1. 账户是否解锁？
2. 余额是否足够（包括Gas费）？
3. Gas Limit是否足够？
4. Nonce是否正确？

**查看详细错误：**
```javascript
> eth.getTransactionReceipt("0xtxhash...").status
"0x0"  // 失败

// 使用debug API查看具体原因
> debug.traceTransaction("0xtxhash...")
```

---

## 九、进阶实践

### 9.1 搭建多节点私有网络

**节点1配置：**
```bash
./build/bin/geth \
  --datadir ./node1 \
  --networkid 12345 \
  --port 30303 \
  --http \
  --http.port 8545 \
  console
```

**节点2配置：**
```bash
./build/bin/geth \
  --datadir ./node2 \
  --networkid 12345 \
  --port 30304 \
  --http \
  --http.port 8546 \
  console
```

**连接节点：**
```javascript
// 在节点1控制台
> admin.nodeInfo.enode
"enode://abc123...@127.0.0.1:30303"

// 在节点2控制台
> admin.addPeer("enode://abc123...@127.0.0.1:30303")
true

// 验证连接
> admin.peers
[...]
```

### 9.2 使用Clique PoA共识

在genesis.json中配置Clique：
```json
{
  "config": {
    "clique": {
      "period": 15,
      "epoch": 30000
    }
  },
  "extradata": "0x0000000000000000000000000000000000000000000000000000000000000000<signerAddress>0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
}
```

---

## 十、实践清单

完成以下任务并截图保存：

- [ ] 成功编译Geth
- [ ] 启动开发链并查看版本
- [ ] 使用控制台查询区块高度
- [ ] 启动和停止挖矿
- [ ] 创建新账户并查看余额
- [ ] 发送Ether交易
- [ ] 部署简单智能合约
- [ ] 调用合约方法并查看事件
- [ ] 使用curl调用RPC接口
- [ ] 使用Web3.js连接节点

**提示：将所有命令输出和截图保存到 `practice/screenshots/` 目录**
